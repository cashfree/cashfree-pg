/* tslint:disable */
/* eslint-disable */
/**
 * Cashfree Payment Gateway APIs
 * Cashfree's Payment Gateway APIs provide developers with a streamlined pathway to integrate advanced payment processing capabilities into their applications, platforms and websites.
 *
 * The version of the OpenAPI document: 2025-01-01
 * Contact: developers@cashfree.com
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

import type { Configuration } from './configuration';
import type { AxiosPromise, AxiosInstance, AxiosRequestConfig } from 'axios';
import globalAxios from 'axios';
// Some imports not used depending on template conditions
// @ts-ignore
import { assertParamExists, setApiKeyToObject, setBasicAuthToObject, setBearerAuthToObject, setOAuthToObject, setSearchParams, serializeDataIfNeeded, toPathString, createRequestFunction } from './common';
import type { RequestArgs } from './base';
// @ts-ignore
import { BASE_PATH, COLLECTION_FORMATS, BaseAPI, RequiredError } from './base';
import { CFEnvironment } from './configuration'
import * as Sentry from "@sentry/node";
import * as crypto from "crypto";



class Environment {
    public PRODUCTION = CFEnvironment.PRODUCTION;
    public SANDBOX = CFEnvironment.SANDBOX;
}

export class PGWebhookEvent {

    type: string;
    raw: string;
    object: any;

    constructor(type: string, rawBody: string, object: any) {
        this.type = type;
        this.raw = rawBody
        this.object = object;
    }
}

export class Cashfree {
    axios: AxiosInstance;
    basePath: string;

    XClientId?: string;
    XClientSecret?: string;
    XPartnerKey?: string;
    XClientSignature?: string;
    XPartnerMerchantId?: string;
    XEnvironment: CFEnvironment;
    XEnableErrorAnalytics: boolean = true;
    XApiVersion: string = "";

    constructor(XEnvironment: CFEnvironment, XClientId?: string, XClientSecret?: string, XPartnerKey?: string, XClientSignature?: string, XPartnerMerchantId?: string, XEnableErrorAnalytics?: boolean, axios?: AxiosInstance) {
        if(XClientId !== undefined && XClientId !== "") {
            this.XClientId = XClientId;
        }
        if(XClientSecret !== undefined && XClientSecret !== "") {
            this.XClientSecret = XClientSecret
        }
        if(XPartnerKey !== undefined && XPartnerKey !== "") {
            this.XPartnerKey = XPartnerKey;
        }
        if(XClientSignature !== undefined && XClientSignature !== "") {
            this.XClientSignature = XClientSignature;
        }
        if(XPartnerMerchantId !== undefined && XPartnerMerchantId !== "") {
            this.XPartnerMerchantId = XPartnerMerchantId;
        }
        this.XEnvironment = XEnvironment;
        if(XEnableErrorAnalytics !== undefined) {
            this.XEnableErrorAnalytics = XEnableErrorAnalytics
        }
        if(this.XEnableErrorAnalytics) {
            Sentry.init({
                dsn: 'https://748d9dcfc4286488867c59651cb6121a@o330525.ingest.sentry.io/4506692796350464',
                
                // Performance Monitoring
                tracesSampleRate: 1.0, // Capture 100% of the transactions, reduce in production!
                profilesSampleRate: 1.0, // Capture 100% of the profiles, reduce in production!

                // Corrected option names
                attachStacktrace: true,  // Lowercase "a"

                beforeSend: (event: Sentry.ErrorEvent): Sentry.ErrorEvent | null => {
                    delete event.contexts?.os;
                    delete event.contexts?.device;
                    delete event.server_name;

                    if (event.exception?.values?.length) {
                        const stackTrace = event.exception.values[0].stacktrace;
                        if (stackTrace?.frames) {
                            const filteredDomains = stackTrace.frames
                                .filter((x) => x.filename.includes("cashfree-pg"))
                                .map((x) => x.filename);

                            if (filteredDomains.length > 0 && filteredDomains[0].includes("cashfree-pg")) {
                                if (this.XEnableErrorAnalytics) {
                                    return event;
                                }
                                return null;
                            }
                        }
                    }
                    return null;
                },
            });
            const scope = Sentry.getCurrentScope();
            if(this.XEnvironment == CFEnvironment.SANDBOX) {
                scope.setExtra('environment', 'sandbox');
            } else {
                scope.setExtra('environment', 'production');
            }
            scope.setExtra('release', "5.1.2");
        }
        if(axios) {
            this.axios = axios;
        }
    }

    /**
     * Use this API to verify your webhook signature once you receive from Cashfree's server.
     * @summary Verify Webhook Signatures
     * @param {string} signature that is present in the header of the webhook ("x-webhook-signature")
     * @param {string} rawBody is the entire body sent to the server in string format
     * @param {string} timestamp that is present in the header of the webhook ("x-webhook-timestamp")
     * @throws {Error}
     */
    public PGVerifyWebhookSignature(signature: string, rawBody: string, timestamp: string) {
        const body = timestamp + rawBody
        const secretKey = this.XClientSecret;
        let generatedSignature = crypto.createHmac('sha256', secretKey).update(body).digest("base64");
        if(generatedSignature === signature) {
            let jsonObject = JSON.parse(rawBody)
            return new PGWebhookEvent(jsonObject.type, rawBody, jsonObject);
        }
        throw new Error("Generated signature and received signature did not match.");
    }

    
}